//
// NtlmAuthenticateMessageTests.swift
//
// Tests for NTLM Type 3 (Authenticate) message.
//

import Foundation
import Testing

@testable import MailFoundation

@Test("NTLM Authenticate message decode Java example")
func ntlmAuthenticateDecodeJavaExample() throws {
    // Example from http://www.innovation.ch/java/ntlm.html
    let rawData: [UInt8] = [
        0x4E, 0x54, 0x4C, 0x4D, 0x53, 0x53, 0x50, 0x00, 0x03, 0x00, 0x00, 0x00, 0x18, 0x00, 0x18,
        0x00,
        0x72, 0x00, 0x00, 0x00, 0x18, 0x00, 0x18, 0x00, 0x8A, 0x00, 0x00, 0x00, 0x14, 0x00, 0x14,
        0x00,
        0x40, 0x00, 0x00, 0x00, 0x0C, 0x00, 0x0C, 0x00, 0x54, 0x00, 0x00, 0x00, 0x12, 0x00, 0x12,
        0x00,
        0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xA2, 0x00, 0x00, 0x00, 0x01, 0x82, 0x00,
        0x00,
        0x55, 0x00, 0x52, 0x00, 0x53, 0x00, 0x41, 0x00, 0x2D, 0x00, 0x4D, 0x00, 0x49, 0x00, 0x4E,
        0x00,
        0x4F, 0x00, 0x52, 0x00, 0x5A, 0x00, 0x61, 0x00, 0x70, 0x00, 0x68, 0x00, 0x6F, 0x00, 0x64,
        0x00,
        0x4C, 0x00, 0x49, 0x00, 0x47, 0x00, 0x48, 0x00, 0x54, 0x00, 0x43, 0x00, 0x49, 0x00, 0x54,
        0x00,
        0x59, 0x00, 0xAD, 0x87, 0xCA, 0x6D, 0xEF, 0xE3, 0x46, 0x85, 0xB9, 0xC4, 0x3C, 0x47, 0x7A,
        0x8C,
        0x42, 0xD6, 0x00, 0x66, 0x7D, 0x68, 0x92, 0xE7, 0xE8, 0x97, 0xE0, 0xE0, 0x0D, 0xE3, 0x10,
        0x4A,
        0x1B, 0xF2, 0x05, 0x3F, 0x07, 0xC7, 0xDD, 0xA8, 0x2D, 0x3C, 0x48, 0x9A, 0xE9, 0x89, 0xE1,
        0xB0,
        0x00, 0xD3,
    ]
    let data = Data(rawData)

    let authenticate = try NtlmAuthenticateMessage(data: data)

    #expect(authenticate.type == 3)
    #expect(authenticate.flags.rawValue == 0x8201)
    #expect(authenticate.domain == "URSA-MINOR")
    #expect(authenticate.userName == "Zaphod")
    #expect(authenticate.workstation == "LIGHTCITY")

    let lmResponse = authenticate.lmChallengeResponse.map { String(format: "%02X", $0) }.joined(separator: "-")
    #expect(
        lmResponse == "AD-87-CA-6D-EF-E3-46-85-B9-C4-3C-47-7A-8C-42-D6-00-66-7D-68-92-E7-E8-97")

    let ntResponse =
        authenticate.ntChallengeResponse?.map { String(format: "%02X", $0) }.joined(separator: "-") ?? ""
    #expect(
        ntResponse == "E0-E0-0D-E3-10-4A-1B-F2-05-3F-07-C7-DD-A8-2D-3C-48-9A-E9-89-E1-B0-00-D3")
}

@Test("NTLM Authenticate message decode Davenport example")
func ntlmAuthenticateDecodeDavenportExample() throws {
    // Example from http://davenport.sourceforge.net/ntlm.html#NtlmAuthenticateMessageExample
    let rawData: [UInt8] = [
        0x4E, 0x54, 0x4C, 0x4D, 0x53, 0x53, 0x50, 0x00, 0x03, 0x00, 0x00, 0x00, 0x18, 0x00, 0x18,
        0x00,
        0x6A, 0x00, 0x00, 0x00, 0x18, 0x00, 0x18, 0x00, 0x82, 0x00, 0x00, 0x00, 0x0C, 0x00, 0x0C,
        0x00,
        0x40, 0x00, 0x00, 0x00, 0x08, 0x00, 0x08, 0x00, 0x4C, 0x00, 0x00, 0x00, 0x16, 0x00, 0x16,
        0x00,
        0x54, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x9A, 0x00, 0x00, 0x00, 0x01, 0x02, 0x00,
        0x00,
        0x44, 0x00, 0x4F, 0x00, 0x4D, 0x00, 0x41, 0x00, 0x49, 0x00, 0x4E, 0x00, 0x75, 0x00, 0x73,
        0x00,
        0x65, 0x00, 0x72, 0x00, 0x57, 0x00, 0x4F, 0x00, 0x52, 0x00, 0x4B, 0x00, 0x53, 0x00, 0x54,
        0x00,
        0x41, 0x00, 0x54, 0x00, 0x49, 0x00, 0x4F, 0x00, 0x4E, 0x00, 0xC3, 0x37, 0xCD, 0x5C, 0xBD,
        0x44,
        0xFC, 0x97, 0x82, 0xA6, 0x67, 0xAF, 0x6D, 0x42, 0x7C, 0x6D, 0xE6, 0x7C, 0x20, 0xC2, 0xD3,
        0xE7,
        0x7C, 0x56, 0x25, 0xA9, 0x8C, 0x1C, 0x31, 0xE8, 0x18, 0x47, 0x46, 0x6B, 0x29, 0xB2, 0xDF,
        0x46,
        0x80, 0xF3, 0x99, 0x58, 0xFB, 0x8C, 0x21, 0x3A, 0x9C, 0xC6,
    ]
    let data = Data(rawData)

    let authenticate = try NtlmAuthenticateMessage(data: data)

    #expect(authenticate.type == 3)
    #expect(authenticate.flags.rawValue == 0x201)
    #expect(authenticate.domain == "DOMAIN")
    #expect(authenticate.userName == "user")
    #expect(authenticate.workstation == "WORKSTATION")

    let lmResponse = authenticate.lmChallengeResponse.map { String(format: "%02X", $0) }.joined(separator: "-")
    #expect(
        lmResponse == "C3-37-CD-5C-BD-44-FC-97-82-A6-67-AF-6D-42-7C-6D-E6-7C-20-C2-D3-E7-7C-56")

    let ntResponse =
        authenticate.ntChallengeResponse?.map { String(format: "%02X", $0) }.joined(separator: "-") ?? ""
    #expect(
        ntResponse == "25-A9-8C-1C-31-E8-18-47-46-6B-29-B2-DF-46-80-F3-99-58-FB-8C-21-3A-9C-C6")
}

@Test("NTLM Authenticate message creation")
func ntlmAuthenticateCreation() throws {
    let negotiate = NtlmNegotiateMessage(domain: "DOMAIN")

    // Build a minimal challenge message
    var challengeData = Data(count: 56)
    let sig: [UInt8] = [0x4E, 0x54, 0x4C, 0x4D, 0x53, 0x53, 0x50, 0x00]
    for (i, b) in sig.enumerated() {
        challengeData[i] = b
    }
    challengeData[8] = 0x02
    // Flags: NegotiateUnicode | NegotiateNtlm | NegotiateExtendedSessionSecurity
    challengeData[20] = 0x01
    challengeData[21] = 0x82
    challengeData[22] = 0x08
    challengeData[23] = 0x00
    // Server challenge
    for i in 0..<8 {
        challengeData[24 + i] = UInt8(0x01 + i)
    }

    let challenge = try NtlmChallengeMessage(data: challengeData)

    let authenticate = NtlmAuthenticateMessage(
        negotiate: negotiate,
        challenge: challenge,
        userName: "testuser",
        password: "testpass",
        domain: "DOMAIN",
        workstation: "WORKSTATION"
    )

    #expect(authenticate.type == 3)
    #expect(authenticate.userName == "testuser")
    #expect(authenticate.domain == "DOMAIN")
    #expect(authenticate.workstation == "WORKSTATION")

    // Encode and verify it starts with NTLMSSP signature and type 3
    let encoded = authenticate.encode()
    #expect(encoded.count > 72)
    #expect(encoded[0] == 0x4E)  // N
    #expect(encoded[8] == 0x03)  // Type 3
}

@Test("NTLM Authenticate invalid signature throws")
func ntlmAuthenticateInvalidSignature() {
    let badData = Data([0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00])

    #expect(throws: NtlmError.self) {
        _ = try NtlmAuthenticateMessage(data: badData)
    }
}
